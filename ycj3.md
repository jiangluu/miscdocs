## 基本介绍
本项目是某棋牌游戏的平台部分。

## 思路
把房间之外的接口都平台化。平台化的含义主要是：
- 不管具体游戏是麻将或斗地主或其他都用同一套
- 分布式设计，故可以扩展到支持百万玩家

分界线在 join_room。join_room及之后的消息属于房间之内，还是发送到原先的java后端（使用原先的websocket协议）。

其他的消息（包括登录、商城、战绩，创建房间等）都发往平台，并且使用HTTP协议。

## 接口通用规则
- 接口是HTTP或HTTPS协议。原则上都是POST请求
- 除了登录接口本身，其他接口都需要登录后才能使用
- 参数都封装成一个json串
- 返回标准HTTP Response

## 接口返回值
返回值一定是以下三类中的一类：
- error: 错误号。表示请求由于某种原因失败 （错误号含义请看文档最后部分）
- OK。 表示请求成功
- 一个json字符串。这说明此请求是获取数据类型的，并且把数据以json的形式传递给前端。  
注意以上所说的返回都是在HTTP的上一层。如果前端请求的url错误，HTTP本身会返回404之类，根本不会进入我们的系统。

## 服务地址
目前开发阶段地址为 http://101.132.111.230:38080/ 。客户端应把此地址写成可配置的。

此地址拼上具体接口就是完整的url， 如ping接口的完整url就是 http://101.132.111.230:38080/api/v1/ping 。

## 如何调试接口
在客户端代码中写完逻辑后，靠实际运行游戏来调用后端接口比较繁琐，建议使用工具直接向后端发送请求，来验证后端接口的正确性。

较常用的工具是curl（windows不自带）；建议可使用chrome浏览器安装插件 Restlet Client - REST API Testing， 使用非常方便。

## 已调通接口
为了醒目，这里先列出后端已经调通的接口，及所使用参数、和返回值。也可以把它们当作例子看待。
| Name | Academy | score | 
| - | :-: | -: | 
| Harry Potter | Gryffindor| 90 | 
| Hermione Granger | Gryffindor | 100 | 
| Draco Malfoy | Slytherin | 90 |

|接口|输入|返回|
| :-- | :--  | :-- |
| /api/v1/ping |无|Your IP is: xxx|



## 具体接口说明
##### /api/v1/ping
健康检查（业务上不需要，只是程序上用，或者可用于测试网速等）

##### /api/v1/check_version
检查客户端版本是否够新。

参数：v:客户端版本号

返回OK表示成功。

##### /api/v1/login_by_openID
使用openID登录。严格来说，只提供这一种登录方式。其他方式（手机号、微信等）是用于换取openID，然后还是要调用本接口登录。

若openID过期，则让用户再使用手机号、微信等方式换取新的openID。

参数：openID

返回：包含所有用户数据的json串，例子： {"coin":10000,"gem":10,"usn":2,"totalWinScore":0,"sex":1,"isguest":1,"nick":"default user","card":50}

##### /api/v1/logout
下线。当客户端关闭时，尽可能调用这个。有利于做在线时长统计等

参数：openID

##### /api/v1/login_guest
游客账号登录。  参数：a:唯一串号。此串号由客户端生产，尽量保证唯一性。串号应该在客户端本地保存。

返回openID，前端应在本地保存。

##### /api/v1/login_phone
手机号登录。

参数：一个json字符串。此json中必须包含以下字段：
> - phone：手机号
> - zone：手机区号
> - code：手机验证码
> - mob_appkey：MOB给此APP的key
> - passwd：密码（的MD5）  
> 可以包含更多的字段，后端会保存下来。
例子：
```json
  {
    "phone": 13112345678,
    "zone": "+86",
    "code": "6379",
    "mob_appkey": "ABCD",
    "passwd": "AJKFJRE6JHNGH9"
}
```
其他请求的参数也是封装成类似的json字符串，不再一一举例。

返回openID，前端应在本地保存。

##### /api/v1/login_wx
使用微信登录。 

参数：客户端拉起微信授权后，微信返回的json字符串。

返回openID，前端应在本地保存。

##### /api/v1/login_qq
使用QQ登录。 

参数：客户端拉起QQ授权后，QQ返回的json字符串。

返回openID，前端应在本地保存。


##### /api/v1/bind_phone
绑定手机号。注意必须在登录后才能调用。下同。

参数：一个json字符串。此json中必须包含以下字段：
> - openID：openID 
> - phone：手机号
> - zone：手机区号
> - code：手机验证码
> - mob_appkey：MOB给此APP的key
> - passwd：密码（的MD5）  

返回OK表示成功。

##### /api/v1/bind_wx
绑定微信。

参数：客户端拉起微信授权后，微信返回的json字符串，在此json中添加一个openID字段

返回OK表示成功。

##### /api/v1/bind_qq
绑定QQ。

参数：客户端拉起微信授权后，微信返回的json字符串，在此json中添加一个openID字段

返回OK表示成功。

##### /api/v1/pay
付费充值。

参数：付费SDK给的所有信息

返回：用户完整信息的json串（与登录的一样）


##### /api/v1/get_user_room
查询自己当前所在房间

参数：openID

返回：一个json串

##### /api/v1/create_room
新建房间

参数： 类似 {"room_type":"SRGP","room_param":"ZR0;1FEN;8JU;FD8;FZPAY","time":1512655446,"openID":"ABCD1234" } ，其中字段的取值均尽量与旧版保持相同。

返回：一个json串


### 错误码
|错误码|表示含义|
| :----------------------------: | :-----------------------------------: |
|215|令牌(openID)不存在或失效|
|220|账号被冻结|
|222|客户端版本不支持|
|301|必须提供密码|
|302|密码不符|
|303|必须提供手机号码|
|304|手机号码不是有效的格式（11位数字）|
|306|手机号码已被占用|
|307|手机验证失败|
|308|不合法的唯一串号（游客登录时）|
|309|微信验证失败|
|310|QQ验证失败|
|380,381|其他内部错误|
|403|必要参数不存在|
