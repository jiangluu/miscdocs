浅夏账号系统SDK后端
====

### 2017-12-25 更新
这里写一些给运维同学看的。

118.178.229.128机器的  /home/jianglu/my 目录下的内容说明：

|目录|内容|备注|
| :----| :------- | :-------|
| asadka |源代码文件|只是作为移交，可随意处理（比方移到其他安全的地方等）。git管理，包含整个历史|
| new_171215|新服务运行文件|端口14333. 开启步骤见下面|
| arun|旧服务运行文件|开启步骤见下面|

##### 开启服务的步骤
账号系统SDK后端非常容易部署，进入目录（如new_171215），运行唯一的可执行程序即可，无命令行参数。能够配置的参数都在asadka.cnf 文件中，一般无需修改。

注意需防止远程登陆断开后影响程序运行，需要使用screen或nohup等来开启服务。

以上步骤适用于新服务和旧服务。

##### 其他基础服务
基础服务都是数据库和消息队列等。无特殊需要一般不关闭。为防万一这里还是把它们列出。

|服务名称|位置|开启命令|备注|
| :----| :------- | :-------| :-------|
| mysql ||开机自动运行||
| ssdb数据库|/home/jianglu/ssdb|./ssdb-server -d aaaa|两台机器是主备。备机用命令 ./ssdb-server -d aaaa_slave 开启|
| disque消息队列|/home/jianglu/github/disque|./disque-server ssss||
| redis缓存|系统路径|redis-server /home/jianglu/redis-4.0-rc2/ssss||


##### 短信模板
老的关于短信模板的配置应该是：
```json
    "sms_templateID": "SMS_56100224",
    "sms_name": "月酌信息",
    "sms_templateID2": "SMS_56020220",
    "sms_name2": "月酌信息",
    "sms_templateID3": "SMS_56170359",
```
可沿用此配置。


### 通用规则
- 密码：密码是长度6~20的字符串，只能由字母和数字组成，不能包括其他特殊字符（如空格等）。前端界面要判断用户输入的密码是否符合规则。调用后端接口时，不传入密码明文而是传入密码的MD5码。
- 后端接口：后端接口技术上来说是一个HTTP GET调用。地址为： 隐藏
文档后面会列出各个具体接口的path，地址拼上path就是完整的调用url。如接口 ping 是用来做健康检查的，完整url就是 隐藏

- 后端接口返回：本账号系统后端的返回只有两类：要么是以 error: 这6个字符开头的字符串，后面跟一个错误号，表示调用失败；如果不是这样，那一定是一个json字符串，表示调用成功。   
前提是url没有拼错。如果访问了根本不存在的url，那么会得到HTTP 502之类。

- 应用Key：由于账号系统需要支持多个应用（或游戏），应用Key是用来区分应用的唯一标识。王骑的应用Key是 隐藏（目前，正式打包前可能改）。所有接口（除了ping之外）的第一个参数都是应用Key。

- 令牌：令牌是作为登录的凭据。作为前端，只要有令牌，就使用令牌登录。如果后端告知令牌失效，再使用其他方式获得令牌，然后还是要使用令牌登录。  
令牌的有效期现在是15天（与使用与否没有关系）。后端也提供了换取新令牌的接口，新令牌的有效期回到15天。  
在下面的接口参数中看到名为openid的参数，就是令牌。

### 具体接口说明

##### ping
健康检查。只要访问后能得到数据，说明后端至少是开启状态。

##### api/v1/newAccount3/:app/:js
使用手机号注册新账号的第一步。:开头的代表参数，以后不赘述。app即是应用Key，以下的各接口不再赘述。js：一个json字符串，至少要包含字段 phone（手机号）和 passwd（密码的MD5码）。可以包含更多其他字段，后端不会拒绝。
成功返回json：字段key，代表一个会话的key，第二步用。

##### api/v1/newAccount3step2/:app/:key/:ma
使用手机号注册新账号的第二步。key：第一步返回值里的key。ma：短信发送给用户手机的验证码（6位数字）。
成功返回json：字段UID：账号的主键，不会变，建议游戏拿去存数据库。openid：令牌。另外还会有第一步时传入的其他值。

##### api/v1/loginAccount2/:app/:phone/:pw
使用手机号和密码获取令牌。参数phone：手机号  pw：密码的MD5码
成功返回json：字段openid：令牌。

##### api/v1/loginAccountByOpenID/:app/:openid
使用令牌登录。openid：令牌。
成功返回json：与注册账号成功后得到的返回一样。

##### api/v1/loginGuest/:app/:key
游客登录。key：客户端自己生成的GUID。
成功返回json：字段UID。

##### api/v1/renewOpenID/:app/:oldopenid
换取新令牌。oldopenid：现有令牌。
成功返回json：字段openid：新令牌。

##### api/v1/resetPasswd2/:app/:phone/:pw
使用手机验证码重置密码，第一步。phone：手机号 pw：新密码的MD5
成功返回json：字段key，代表一个会话的key，第二步用。

##### api/v1/resetPasswd2step2/:app/:key/:ma
使用手机验证码重置密码，第二步。key：第一步返回值里的key。ma：短信发送给用户手机的验证码（6位数字）。
成功返回json：{"OK":1}

##### api/v1/logout/:app/:openid
登出。openid：令牌。
成功返回json：{"OK":1}

##### api/v1/resetPhone/:app/:phone/:oldpw/:newphone/:newpw
换绑第一步。phone：现手机号 oldpw：现密码的MD5 newphone：要换的新手机号 newpw：要换的新密码
成功返回json：字段key，代表一个会话的key，第二步用。

##### api/v1/resetPhonestep2/:app/:key/:ma
换绑第二步。key：第一步返回值里的key。ma：短信发送给用户手机的验证码（6位数字）。注意，换绑后，后端会把此账号的令牌无效化。所以用户需要重新走登录流程拿新令牌。
成功返回json：{"OK":1}

##### api/v1/STSetCoin/:app/:openid/:coin1/:coin2/:coin3/:coin4
数据统计-报告用户货币。参数 openid：令牌。coin1~4：4种货币的值。游戏不满4种货币的填0补满4个参数。coin1一定要填本游戏付费买来的货币（元宝等），后面三个游戏自己决定。
成功返回json：{"OK":1}

##### api/v1/STPay/:app/:openid/:amount/:qudao/:itemid/:coinadded
数据统计-报告应用的一笔充值。openid：令牌。 amount：充值花费人民币数额（单位元）。qudao：充值渠道（支付宝、微信等）。itemid：充值购买的是什么。coinadded：这笔充值值多少元宝（不值元宝的话填0）。
成功返回json：{"OK":1}

##### api/v1/STCoinConsume/:app/:openid/:amount/:typr
数据统计-报告应用的一笔消费（即在游戏里花了货币）。openid：令牌。 amount：数额（单位：游戏里的单位）。typr：1~4，对应STSetCoin接口的coin1~4。
成功返回json：{"OK":1}

##### api/v1/STCoinAdd/:app/:openid/:amount/:typr
数据统计-报告应用的一笔收入（即在游戏里得到了某种货币）。参数含义同上一个接口。
成功返回json：{"OK":1}

### 错误码
|错误码|表示含义|
| :----------------------------: | :-----------------------------------: |
|210|无效的appkey|
|211|不存在的UID|
|212|不存在的SN|
|213|不存在的手机号码|
|214|不存在的邮箱|
|215|令牌不存在或失效|
|220|账号被冻结|
|301|必须提供密码|
|302|密码不符|
|303|必须提供手机号码|
|304|手机号码不是有效的格式（11位数字）|
|306|手机号码已被占用|
|307|手机验证码不符|
|380,381|其他内部错误|
|501|短信接口发送短信失败（客户端可提示稍后再点击获取验证码）|
|309|必须提供email|
|310|email不是有效的格式|
|311|email已被占用|
|503|发邮件失败|

